package app;

import java.sql.*;

public class AppointmentDAO {

    private static final String URL = "jdbc:mysql://codevlab.kr:3306/bottomup2?serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true&useSSL=false";
    private static final String USER = "bottomup2";
    private static final String PASS = "bottomup22";

    private Connection getConnection() throws SQLException {
        return DriverManager.getConnection(URL, USER, PASS);
    }


     // [기능 1] 예약 등록

    public void register(String pName, String phone, String dName, String appDate) {
        if (appDate.length() == 16) appDate += ":00";

        String findPatientSql = "SELECT patient_id FROM patients WHERE patient_name = ? AND phone = ?";
        String findDoctorSql = "SELECT doctor_id FROM doctors WHERE doctor_name = ? LIMIT 1";
        String checkSql = "SELECT COUNT(*) FROM appointments WHERE doctor_id = ? AND app_date = ? AND situation = '예약완료'";
        String insertSql = "INSERT INTO appointments (patient_id, doctor_id, app_date, situation) VALUES (?, ?, ?, '예약완료')";

        try (Connection conn = getConnection()) {
            // 1. 환자 확인
            int pId = -1;
            try (PreparedStatement pstmt = conn.prepareStatement(findPatientSql)) {
                pstmt.setString(1, pName);
                pstmt.setString(2, phone);
                ResultSet rs = pstmt.executeQuery();
                if (rs.next()) pId = rs.getInt("patient_id");
                else {
                    System.out.println("등록되지 않은 환자 정보입니다.");
                    return;
                }
            }

            // 2. 의사 확인
            int dId = -1;
            try (PreparedStatement pstmt = conn.prepareStatement(findDoctorSql)) {
                pstmt.setString(1, dName);
                ResultSet rs = pstmt.executeQuery();
                if (rs.next()) dId = rs.getInt("doctor_id");
                else {
                    System.out.println("존재하지 않는 의사 이름입니다.");
                    return;
                }
            }

            // 3. 중복 체크
            try (PreparedStatement pstmt = conn.prepareStatement(checkSql)) {
                pstmt.setInt(1, dId);
                pstmt.setString(2, appDate);
                ResultSet rs = pstmt.executeQuery();
                if (rs.next() && rs.getInt(1) > 0) {
                    System.out.println("해당 시간대에 의사 ["+dName+"]님은 이미 예약이 완료되었습니다.");
                    return;
                }
            }

            // 4. 등록
            try (PreparedStatement pstmt = conn.prepareStatement(insertSql)) {
                pstmt.setInt(1, pId);
                pstmt.setInt(2, dId);
                pstmt.setString(3, appDate);
                pstmtInsert(pstmt, pName, dName);
            }
        } catch (SQLException e) {
            System.err.println("DB 오류: " +e.getMessage());
        }
    }

    private void pstmtInsert(PreparedStatement pstmt, String pName, String dName) throws SQLException {
        pstmt.executeUpdate();
        System.out.println("["+pName+"]님, ["+dName+"] 의사에게 예약이 완료되었습니다.");
    }


     // [기능 2] 예약 내역 확인 
    
    public void printAppointments(String name, String phone) {
        String sql = "SELECT a.app_id, a.app_date, d.doctor_name, a.situation " +
                     "FROM appointments a " +
                     "JOIN patients p ON a.patient_id = p.patient_id " +
                     "JOIN doctors d ON a.doctor_id = d.doctor_id " +
                     "WHERE p.patient_name = ? AND p.phone = ? ORDER BY a.app_date ASC";

        System.out.println("\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
        System.out.println("      ["+name+"]님의 예약 내역");
        System.out.println("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");

        try (Connection conn = getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setString(1, name);
            pstmt.setString(2, phone);
            try (ResultSet rs = pstmt.executeQuery()) {
                boolean hasData = false;
                while (rs.next()) {
                    hasData = true;
                    System.out.printf("[번호:%d] 일시:%s | 의사:%s | 상태:%s%n", 
                        rs.getInt("app_id"), rs.getString("app_date"), 
                        rs.getString("doctor_name"), rs.getString("situation"));
                }
                if (!hasData) System.out.println("검색된 예약 내역이 없습니다.");
            }
        } catch (SQLException e) {
            System.err.println("조회 오류: " +e.getMessage());
        }
        System.out.println("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
    }

     // [기능 3] 예약 취소 

    public void cancelWithAuth(int appId, String name, String phone) {
        String sql = "UPDATE appointments a"+
                     "JOIN patients p ON a.patient_id = p.patient_id"+
                     "SET a.situation = '취소완료'"+
                     "WHERE a.app_id = ? AND p.patient_name = ? AND p.phone = ?";

        try (Connection conn = getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setInt(1, appId);
            pstmt.setString(2, name);
            pstmt.setString(3, phone);
            
            if (pstmt.executeUpdate() > 0) {
                System.out.println("예약 번호 ["+appId+"]번이 [취소완료] 되었습니다.");
            } else {
                System.out.println("취소 실패: 정보가 일치하지 않거나 이미 취소된 상태입니다.");
            }
        } catch (SQLException e) {
            System.err.println("취소 오류: " +e.getMessage());
        }
    }
}
