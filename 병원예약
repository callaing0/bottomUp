package app;

import java.sql.*;

public class App {

	// 1. DB ì—°ê²° ì„¤ì • ì •ë³´
	private static final String URL = "jdbc:mysql://codevlab.kr:3306/bottomup2?serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true&useSSL=false";
    private static final String USER = "bottomup2";
    private static final String PASS = "bottomup22";
    /**
     * DB ì—°ê²° ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œ
     */
    private Connection getConnection() throws SQLException {
        // ë“œë¼ì´ë²„ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œ (í•„ìš” ì‹œ)
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            System.err.println("âŒ MySQL ë“œë¼ì´ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.getMessage());
        }
        return DriverManager.getConnection(URL, USER, PASS);
    }

    /**
     * [ê¸°ëŠ¥ 1] ì‹ ê·œ ì˜ˆì•½ ë“±ë¡ (Register)
     */
    public void register(int patientId, int doctorId, String appDate, String situation) {
        // ì¤‘ë³µ ì²´í¬ ì¿¼ë¦¬ (ì˜ì‚¬ì™€ ì‹œê°„ì´ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸)
        String checkSql = "SELECT COUNT(*) FROM appointments WHERE doctor_id = ? AND app_date = ?";
        // ë°ì´í„° ì‚½ì… ì¿¼ë¦¬
        String insertSql = "INSERT INTO appointments (patient_id, doctor_id, app_date, situation) VALUES (?, ?, ?, ?)";

        try (Connection conn = getConnection()) {
            
            // 1. ì¤‘ë³µ í™•ì¸
            try (PreparedStatement pstmtCheck = conn.prepareStatement(checkSql)) {
                pstmtCheck.setInt(1, doctorId);
                pstmtCheck.setString(2, appDate);
                ResultSet rs = pstmtCheck.executeQuery();
                
                if (rs.next() && rs.getInt(1) > 0) {
                    System.out.println("âŒ ì˜ˆì•½ ì‹¤íŒ¨: í•´ë‹¹ ì˜ì‚¬ëŠ” [" + appDate + "]ì— ì´ë¯¸ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
            }

            // 2. ì˜ˆì•½ ë“±ë¡
            try (PreparedStatement pstmtInsert = conn.prepareStatement(insertSql)) {
                pstmtInsert.setInt(1, patientId);
                pstmtInsert.setInt(2, doctorId);
                pstmtInsert.setString(3, appDate);
                pstmtInsert.setString(4, situation);
                
                pstmtInsert.executeUpdate();
                System.out.println("âœ… ì˜ˆì•½ì´ DBì— ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

        } catch (SQLException e) {
            System.err.println("âŒ DB ì‘ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
        }
    }

    /**
     * [ê¸°ëŠ¥ 2] ì „ì²´ ì˜ˆì•½ ë‚´ì—­ í™•ì¸ (Viewer)
     */
    public void printAllAppointments() {
        String selectSql = "SELECT * FROM appointments ORDER BY app_date ASC";

        System.out.println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        System.out.println("          ğŸ¥ í˜„ì¬ ì „ì²´ ì˜ˆì•½ í˜„í™©");
        System.out.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

        try (Connection conn = getConnection();
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(selectSql)) {

            boolean hasData = false;
            while (rs.next()) {
                hasData = true;
                int appId = rs.getInt("app_id");
                int pId = rs.getInt("patient_id");
                int dId = rs.getInt("doctor_id");
                String date = rs.getString("app_date");
                String status = rs.getString("situation");

                System.out.printf("[ë²ˆí˜¸:%d] í™˜ì:%d | ì˜ì‚¬:%d | ì¼ì‹œ:%s | ìƒíƒœ:%s%n", 
                                  appId, pId, dId, date, status);
            }

            if (!hasData) {
                System.out.println("í˜„ì¬ ë“±ë¡ëœ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
            }

        } catch (SQLException e) {
            System.err.println("âŒ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
        }
        System.out.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    }
}
