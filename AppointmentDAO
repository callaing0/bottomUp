package app;

import java.sql.*;

public class AppointmentDAO {

    private static final String URL = "jdbc:mysql://codevlab.kr:3306/bottomup2?serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true&useSSL=false";
    private static final String USER = "bottomup2";
    private static final String PASS = "bottomup22";

    private Connection getConnection() throws SQLException {
        return DriverManager.getConnection(URL, USER, PASS);
    }

    /**
     * [ê¸°ëŠ¥ 1] ì˜ˆì•½ ë“±ë¡
     * ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¡œ í™˜ì IDë¥¼ ì°¾ê³ , ì˜ì‚¬ ì´ë¦„ìœ¼ë¡œ ì˜ì‚¬ IDë¥¼ ì°¾ì•„ ë“±ë¡í•©ë‹ˆë‹¤.
     */
    public void register(String pName, String phone, String dName, String appDate) {
        // ë¶„ ë‹¨ìœ„ ì…ë ¥ ì‹œ ì´ˆ(:00) ìë™ ì¶”ê°€
        if (appDate.length() == 16) appDate += ":00";

        String findPatientSql = "SELECT patient_id FROM patients WHERE patient_name = ? AND phone = ?";
        String findDoctorSql = "SELECT doctor_id FROM doctors WHERE doctor_name = ? LIMIT 1";
        String checkSql = "SELECT COUNT(*) FROM appointments WHERE doctor_id = ? AND app_date = ? AND situation = 'ì˜ˆì•½ì™„ë£Œ'";
        String insertSql = "INSERT INTO appointments (patient_id, doctor_id, app_date, situation) VALUES (?, ?, ?, 'ì˜ˆì•½ì™„ë£Œ')";

        try (Connection conn = getConnection()) {
            // 1. í™˜ì í™•ì¸
            int pId = -1;
            try (PreparedStatement pstmt = conn.prepareStatement(findPatientSql)) {
                pstmt.setString(1, pName);
                pstmt.setString(2, phone);
                ResultSet rs = pstmt.executeQuery();
                if (rs.next()) pId = rs.getInt("patient_id");
                else {
                    System.out.println("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ í™˜ì ì •ë³´ì…ë‹ˆë‹¤.");
                    return;
                }
            }

            // 2. ì˜ì‚¬ í™•ì¸
            int dId = -1;
            try (PreparedStatement pstmt = conn.prepareStatement(findDoctorSql)) {
                pstmt.setString(1, dName);
                ResultSet rs = pstmt.executeQuery();
                if (rs.next()) dId = rs.getInt("doctor_id");
                else {
                    System.out.println("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì˜ì‚¬ ì´ë¦„ì…ë‹ˆë‹¤.");
                    return;
                }
            }

            // 3. ì¤‘ë³µ ì²´í¬
            try (PreparedStatement pstmt = conn.prepareStatement(checkSql)) {
                pstmt.setInt(1, dId);
                pstmt.setString(2, appDate);
                ResultSet rs = pstmt.executeQuery();
                if (rs.next() && rs.getInt(1) > 0) {
                    System.out.println("âŒ í•´ë‹¹ ì‹œê°„ëŒ€ì— ì˜ì‚¬ [" + dName + "]ë‹˜ì€ ì´ë¯¸ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    return;
                }
            }

            // 4. ë“±ë¡
            try (PreparedStatement pstmt = conn.prepareStatement(insertSql)) {
                pstmt.setInt(1, pId);
                pstmt.setInt(2, dId);
                pstmt.setString(3, appDate);
                pstmtInsert(pstmt, pName, dName);
            }
        } catch (SQLException e) {
            System.err.println("âŒ DB ì˜¤ë¥˜: " + e.getMessage());
        }
    }

    private void pstmtInsert(PreparedStatement pstmt, String pName, String dName) throws SQLException {
        pstmt.executeUpdate();
        System.out.println("âœ… [" + pName + "]ë‹˜, [" + dName + "] ì˜ì‚¬ì—ê²Œ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    /**
     * [ê¸°ëŠ¥ 2] ì˜ˆì•½ ë‚´ì—­ í™•ì¸ (ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ê¸°ì¤€)
     */
    public void printAppointments(String name, String phone) {
        String sql = "SELECT a.app_id, a.app_date, d.doctor_name, a.situation " +
                     "FROM appointments a " +
                     "JOIN patients p ON a.patient_id = p.patient_id " +
                     "JOIN doctors d ON a.doctor_id = d.doctor_id " +
                     "WHERE p.patient_name = ? AND p.phone = ? ORDER BY a.app_date ASC";

        System.out.println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        System.out.println("    ğŸ” [" + name + "]ë‹˜ì˜ ì˜ˆì•½ ë‚´ì—­");
        System.out.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

        try (Connection conn = getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setString(1, name);
            pstmt.setString(2, phone);
            try (ResultSet rs = pstmt.executeQuery()) {
                boolean hasData = false;
                while (rs.next()) {
                    hasData = true;
                    System.out.printf("[ë²ˆí˜¸:%d] ì¼ì‹œ:%s | ì˜ì‚¬:%s | ìƒíƒœ:%s%n", 
                        rs.getInt("app_id"), rs.getString("app_date"), 
                        rs.getString("doctor_name"), rs.getString("situation"));
                }
                if (!hasData) System.out.println("ê²€ìƒ‰ëœ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        } catch (SQLException e) {
            System.err.println("âŒ ì¡°íšŒ ì˜¤ë¥˜: " + e.getMessage());
        }
        System.out.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    }

    /**
     * [ê¸°ëŠ¥ 3] ì˜ˆì•½ ì·¨ì†Œ (ë³¸ì¸ í™•ì¸ í¬í•¨)
     */
    public void cancelWithAuth(int appId, String name, String phone) {
        String sql = "UPDATE appointments a " +
                     "JOIN patients p ON a.patient_id = p.patient_id " +
                     "SET a.situation = 'ì·¨ì†Œì™„ë£Œ' " +
                     "WHERE a.app_id = ? AND p.patient_name = ? AND p.phone = ?";

        try (Connection conn = getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setInt(1, appId);
            pstmt.setString(2, name);
            pstmt.setString(3, phone);
            
            if (pstmt.executeUpdate() > 0) {
                System.out.println("âœ… ì˜ˆì•½ ë²ˆí˜¸ [" + appId + "]ë²ˆì´ [ì·¨ì†Œì™„ë£Œ] ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                System.out.println("âŒ ì·¨ì†Œ ì‹¤íŒ¨: ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì·¨ì†Œëœ ìƒíƒœì…ë‹ˆë‹¤.");
            }
        } catch (SQLException e) {
            System.err.println("âŒ ì·¨ì†Œ ì˜¤ë¥˜: " + e.getMessage());
        }
    }
}
